name: Auto Retry Dependencies Merges

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  auto-merge-failed-prs:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write  # Allow merging PRs
      contents: read  # Read access to repo contents

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Retry PRs with 'dependencies' label, including 'UNKNOWN' status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Pass the GITHUB_TOKEN to gh CLI
        run: |
          pr_list=$(gh pr list --state open --label "dependencies" --json number,mergeable -q '.[].number')
          echo "PR list with dependencies: $pr_list"
          
          for pr_number in $pr_list; do
            mergeable_status=$(gh pr view $pr_number --json mergeable -q '.mergeable')

            if [[ "$mergeable_status" == "CONFLICT" ]]; then
                echo "PR #$pr_number has conflicts. Skipping merge attempt."
            elif [[ "$mergeable_status" == "UNKNOWN" ]]; then
                echo "PR #$pr_number is in 'UNKNOWN' state. Attempting to merge... (Retry)"
                if ! gh pr merge $pr_number --merge --auto --delete-branch; then
                  echo "Failed to merge PR #$pr_number despite being in 'UNKNOWN' state."
                else
                  echo "Successfully merged PR #$pr_number in 'UNKNOWN' state."
                fi
            else
                echo "Attempting to auto-merge PR #$pr_number..."
                if ! gh pr merge $pr_number --merge --auto --delete-branch; then
                  echo "Failed to merge PR #$pr_number."
                else
                  echo "Successfully merged PR #$pr_number."
                fi
            fi
          done



      - name: Retry Failed PRs in Subsequent Workflow
        run: |
          # If there are failed PRs, attempt to merge them in the next run
          if [ -f failed_prs.txt ]; then
            echo "Reprocessing failed PRs..."
            failed_prs=$(cat failed_prs.txt)
            for failed_pr in $failed_prs; do
              pr_number=$(echo $failed_pr | awk '{print $NF}')  # Extract the PR number
              echo "Attempting to re-merge PR #$pr_number..."
              
              # Retry the merge for the failed PR
              if ! gh pr merge $pr_number --merge --auto --delete-branch; then
                echo "Failed to re-merge PR #$pr_number after retry."
              else
                echo "Successfully re-merged PR #$pr_number."
              fi
            done
          fi
