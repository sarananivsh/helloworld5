name: Auto Retry Dependencies Merges

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  retry-auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI
        run: |
          # Install GitHub CLI
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Get all open PRs with 'dependencies' label
        id: pr_list
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Pass GITHUB_TOKEN to gh CLI
        run: |
          # Get a list of PRs with 'dependencies' label and check for their merge status
          pr_list=$(gh pr list --state open --label "dependencies" --json number,mergeable -q '.[].number')
          echo "PR list with dependencies: $pr_list"
          echo "::set-output name=pr_list::$pr_list"

      - name: Retry failed auto-merges for 'dependencies' label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Pass GITHUB_TOKEN to gh CLI
        run: |
          # Fetch PR numbers from the previous step
          pr_list="${{ steps.pr_list.outputs.pr_list }}"
          
          # Loop through each PR number to check mergeability and retry if failed
          for pr_number in $pr_list; do
            # Check the mergeable status of each PR
            mergeable_status=$(gh pr view $pr_number --json mergeable -q '.mergeable')

            if [[ "$mergeable_status" == "CONFLICT" ]]; then
                echo "PR #$pr_number has conflicts. Skipping merge attempt."
            elif [[ "$mergeable_status" == "UNKNOWN" ]]; then
                echo "PR #$pr_number is in an unknown state. Skipping merge attempt."
            else
                echo "Attempting to auto-merge PR #$pr_number with 'dependencies' label..."

                # Attempt auto-merge and delete the branch if successful
                gh pr merge $pr_number --merge --auto --delete-branch || echo "Failed to merge PR #$pr_number."
            fi
          done
